<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Tic-Tac-Toe Pro PWA</title>

<link rel="manifest" href="manifest.json">

<!-- Firebase (CDN â€“ works in APK/PWA) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script src="https://cdn.tailwindcss.com"></script>

<script>
/* ================= FIREBASE INIT ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCY2qB4sbPs_7BIz355cQiQkDDqK-S_z4I",
  authDomain: "flux-chat-b9cb2.firebaseapp.com",
  projectId: "flux-chat-b9cb2",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= MULTIPLAYER STATE ================= */
let isOnline = false;
let gameId = null;
let mySymbol = null;
let unsubscribe = null;

/* ================= EXISTING STATE (UNCHANGED) ================= */
const boardArr = Array(9).fill(null);
let currentPlayer = 'X';
let scores = { X: 0, O: 0, draw: 0 };
let roundHistory = [];
let isGameActive = true;
let isVsCpu = false;

/* ================= DOM (UNCHANGED) ================= */
const cells = document.querySelectorAll('.cell');
const statusEl = document.getElementById('status');

/* ================= ONLINE GAME ================= */
async function startOrJoinOnline() {
  isOnline = true;

  const snap = await db.collection("ttt-games")
    .where("players", "<", 2)
    .limit(1)
    .get();

  if (snap.empty) {
    const doc = await db.collection("ttt-games").add({
      board: Array(9).fill(null),
      currentPlayer: "X",
      players: 1,
      winner: null
    });
    gameId = doc.id;
    mySymbol = "X";
  } else {
    const doc = snap.docs[0];
    gameId = doc.id;
    mySymbol = "O";
    await doc.ref.update({ players: 2 });
  }

  listenOnlineGame();
}

function listenOnlineGame() {
  unsubscribe = db.collection("ttt-games").doc(gameId)
    .onSnapshot(doc => {
      const data = doc.data();
      if (!data) return;

      data.board.forEach((v, i) => {
        boardArr[i] = v;
        cells[i].innerText = v || '';
      });

      currentPlayer = data.currentPlayer;

      if (data.winner) {
        isGameActive = false;
        statusEl.innerText =
          data.winner === "Draw" ? "Draw!" : `${data.winner} Wins!`;
      }
    });
}

/* ================= MOVE HANDLER ================= */
function executeMove(index) {
  if (isOnline) {
    if (currentPlayer !== mySymbol) return;
    boardArr[index] = mySymbol;

    const winner = checkWinner(boardArr);

    db.collection("ttt-games").doc(gameId).update({
      board: boardArr,
      currentPlayer: mySymbol === "X" ? "O" : "X",
      winner
    });
    return;
  }

  /* OFFLINE (YOUR ORIGINAL LOGIC CONTINUES) */
}

/* ================= WIN CHECK ================= */
function checkWinner(b) {
  const wins = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
  ];
  for (let p of wins) {
    if (b[p[0]] && b[p[0]] === b[p[1]] && b[p[0]] === b[p[2]])
      return b[p[0]];
  }
  if (!b.includes(null)) return "Draw";
  return null;
}

/* ================= EVENTS ================= */
cells.forEach(c => {
  c.onclick = () => {
    const i = c.dataset.index;
    if (!boardArr[i] && isGameActive) executeMove(i);
  };
});

/* PvP = ONLINE */
pvpBtn.onclick = () => {
  isVsCpu = false;
  startOrJoinOnline();
};

/* vs CPU = OFFLINE */
pvcBtn.onclick = () => {
  isVsCpu = true;
  isOnline = false;
  if (unsubscribe) unsubscribe();
};

/* ================= LOAD ================= */
window.onload = () => {
  statusEl.innerText = "Select Mode";
};
</script>
</head>

<!-- BODY & UI BELOW IS 100% YOUR ORIGINAL CODE -->
<!-- NOTHING CHANGED -->

<body class="min-h-screen flex flex-col items-center justify-start p-4 pt-24 md:pt-12 md:justify-center">
<!-- ðŸ”’ YOUR ENTIRE UI CODE CONTINUES EXACTLY AS YOU SENT -->
</body>
</html>
